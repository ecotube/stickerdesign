var currentStickerIndex=0,stickersConfig=[],selectedStickerObj=null,standardWidth=480,leftPadding=15,standardHeight=720,modelImageWidth=0,modelImageHeight=0,points={p36:{x:145.090714,y:388.185455},p28:{x:226.809326,y:413.432007},p45:{x:316.302063,y:386.818054},p31:{x:202.558029,y:478.747101},p30:{x:224.125854,y:464.141724},p35:{x:252.042282,y:478.494385},p32:{x:213.58075,y:482.631195},p33:{x:226.403198,y:486.41156},p34:{x:239.940094,y:482.355194},p61:{x:215.36615,y:521.271179},p62:{x:228.104187,y:521.828186},
    p63:{x:241.25206,y:520.668823},p48:{x:183.998306,y:525.298035},p66:{x:227.626801,y:523.914185},p54:{x:278.198853,y:522.706726},p48:{x:183.998306,y:525.298035},p57:{x:228.023361,y:547.001709}},standardOffsetWidthScale=distance(points.p36,points.p45)/standardWidth,pointConfig={eye:{widthBasePoints:[points.p36,points.p45],center:points.p28,pos:2},nose:{widthBasePoints:[points.p31,points.p35],center:points.p30,pos:4},nostril:{widthBasePoints:[points.p32,points.p34],center:points.p33,pos:5},upperlip_bottom:{widthBasePoints:[points.p61,
    points.p63],center:points.p62,pos:6},underlip_bottom:{widthBasePoints:[points.p48,points.p54],center:points.p66,pos:7},underlip_top:{widthBasePoints:[points.p48,points.p54],center:points.p57,pos:9}};
$(document).ready(function(){setModelParam();$(".sticker-div").click(function(){stickerChosen($(this))});$("#uploader").click(function(){$("#media").click()});$(document).on("change","input#media",function(){ajaxFileUpload()});$("#fin").click(function(){finishSticker()});$("#finall").click(function(){uploadConfig()});$("input[type='radio']").click(function(){noActiveSticker()||(0!=$("#sticker_"+currentStickerIndex).size()&&$("#sticker_"+currentStickerIndex).remove(),addStickerToModel(calculatePos()),
    dragNResize())})});function noActiveSticker(){return 0==$(".uploaded>.active").size()?(notify("\u8bf7\u5148\u9009\u62e9\u4e00\u5f20\u8d34\u7eb8!"),$(this).prop("checked",!1),!0):!1}function setModelParam(){document.getElementById("model-image").onload=function(){modelImageHeight=$(this).height();modelImageWidth=$(this).width()};modelImageHeight=0==modelImageHeight?$("#model-image").height():modelImageHeight;modelImageWidth=0==modelImageWidth?$("#model-image").width():modelImageWidth}
function uploadConfig(){$.ajax({url:"json.php",method:"POST",dataType:"json",data:JSON.stringify(stickersConfig),success:function(a,b,c){window.location.href="download.php"},error:function(){notify("\u4e0a\u4f20\u9519\u8bef, \u8bf7\u7a0d\u540e\u518d\u8bd5")}})}
function finishSticker(){var a={};a.facePos=pointConfig[$("input[type='radio']:checked").val()].pos;a.scaleWidthOffset=parseFloat(getWidthOffset());a.scaleXOffset=parseFloat(getXOffset());a.scaleYOffset=parseFloat(getYOffset());a.frameFolder=$("#frame_folder").val();a.frameNum=$("#frame_num").val();a.frameWidth=$("#tmp").width();a.frameHeight=$("#tmp").height();stickersConfig[currentStickerIndex]=a;notify("\u8d34\u7eb8\u53c2\u6570\u4fdd\u5b58\u6210\u529f","alert-success")}
function getWidthOffset(){return(widthDifference()/standardModelOffsetWidth()).toFixed(2)}function widthDifference(){return parseFloat($("#sticker_"+currentStickerIndex+">img").width())-stickerBaseWidth()}function heightDifference(){return parseFloat(widthDifference()/$("#tmp").width()*$("#tmp").height())}
function getXOffset(){var a=$("#sticker_"+currentStickerIndex).css("left"),a=parseFloat(a.substring(0,a.length-2))-leftPadding;return((a+parseFloat($("#sticker_"+currentStickerIndex+">img").attr("data-x"))-a+widthDifference()/2)/standardModelOffsetWidth()).toFixed(2)}
function getYOffset(){var a=$("#sticker_"+currentStickerIndex).css("top"),a=parseFloat(a.substring(0,a.length-2));return((a+parseFloat($("#sticker_"+currentStickerIndex+">img").attr("data-y"))-a+heightDifference()/2)/standardModelOffsetWidth()).toFixed(2)}function stickerBaseWidth(){var a=pointConfig[$("input[type='radio']:checked").val()].widthBasePoints;return parseFloat(distance(a[0],a[1])*standardWidth/modelImageWidth)}
function distance(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))}function addStickerToModel(a){a='<div id="sticker_'+currentStickerIndex+'" class="active" style="z-index:99999;position:absolute;left:'+(leftPadding+a.x)+"px;top:"+a.y+"px;width:"+a.width+'px;"><img class="full" src="'+selectedStickerObj.attr("src")+'"/></div>';a=$(a);$("#model").append(a)}
function dragNResize(){interact("#sticker_"+currentStickerIndex+">img").draggable({inertia:!0,autoScroll:!0,restrict:{restriction:"#model"},onmove:dragMoveListener}).resizable({preserveAspectRatio:!0,edges:{left:!0,right:!0,bottom:!0,top:!0}}).on("resizemove",function(a){var b=a.target,c=parseFloat(b.getAttribute("data-x"))||0,d=parseFloat(b.getAttribute("data-y"))||0;b.style.width=a.rect.width+"px";b.style.height=a.rect.height+"px";c+=a.deltaRect.left;d+=a.deltaRect.top;b.style.webkitTransform=b.style.transform=
    "translate("+c+"px,"+d+"px)";b.setAttribute("data-x",c);b.setAttribute("data-y",d);b.textContent=Math.round(a.rect.width)+"\u00d7"+Math.round(a.rect.height)}).on(["mouseover"],function(a){$("#sticker_"+currentStickerIndex+">img").css("border","1px solid #fdfdfd").css("border-radius","4px")}).on(["mouseout"],function(a){$("#sticker_"+currentStickerIndex+">img").css("border","none")})}
function dragMoveListener(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx;a=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+a+"px)";b.setAttribute("data-x",c);b.setAttribute("data-y",a)}
function calculatePos(){var a=pointConfig[$("input[type='radio']:checked").val()],b={};b.width=stickerBaseWidth();b.x=a.center.x/standardWidth*modelImageWidth-b.width/2;b.y=a.center.y/standardHeight*modelImageHeight-b.width/selectedStickerObj.width()*selectedStickerObj.height()/2;return b}
function stickerChosen(a){a.siblings().attr("style","").removeClass("active");a.attr("style","border-top:3px solid #62addf").addClass("active");currentStickerIndex=a.index();$("#model").children().removeClass("active");selectedStickerObj=a.children("img");useLastStickerConfig();$("#tmp").attr("src",selectedStickerObj.attr("src"))}
function useLastStickerConfig(){if(stickersConfig[currentStickerIndex]){$("#frame_folder").val(stickersConfig[currentStickerIndex].frameFolder);$("#frame_num").val(stickersConfig[currentStickerIndex].frameNum);for(var a in pointConfig)pointConfig[a].pos==parseInt(stickersConfig[currentStickerIndex].facePos,10)&&$("input[value='"+a+"']").prop("checked",!0);dragNResize()}}function standardModelOffsetWidth(){return standardOffsetWidthScale*modelImageWidth}
function addUploadedSticker(a){a=$('<div class="col-md-3 col-lg-3 col-sm-3 sticker-div"><img src="'+a.file+'" class="img-rounded full"/></div>');$(".uploaded").append(a);$("img",a).click(function(){stickerChosen($(this).parent())})}function ajaxFileUpload(){$.ajaxFileUpload({url:"file.php",secureuri:!1,fileElementId:"media",dataType:"json",success:function(a,b){addUploadedSticker(a)},error:function(a,b,c){notify("\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01")}});return!1}
function notify(a,b){b=b?b:"alert-warning";console.log(b);$(".message").addClass(b).html(a);$(".message").show();setTimeout(function(){$(".message").fadeOut(500)},1500);setTimeout(function(){$(".message").removeClass(b)},2E3)};