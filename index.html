<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="author" content="camo digital inc.">
	<title> For Sticker Designers</title>
	<link href="./css/bootstrap.min.css" rel="stylesheet">
	<link href="./css/bootstrap-slider.min.css" rel="stylesheet">
	<style>
		body {font-family: century; color:#716f6f; font-size:14px;}
		img.full {width: 100%;}
		.top-2 {margin-top: 2%;}
		.top-5 {margin-top: 5%;}
		.bottom-5 {margin-bottom: 5%;}
		.left-2 {margin-left: 2%;}
		.uploaded{background-color:#eee;border-radius:10px;margin-left:2%;}
		.uploaded img{cursor:pointer;padding:20px 0;}
		.center-select{padding-left:2%;}
		#parameter {margin-left:2%;}
		.bigfont {font-size:18px;}
		.slider{margin-left:4%;}
		#width .slider-handle, #width .slider-selection{background: #62addf;}
		#x .slider-handle, #x .slider-selection{background: #8ebd8b;}
		#y .slider-handle, #y .slider-selection{background: #bd8b90;}
		.sticker-div{border-radius:2px;}
	</style>
</head>
<body>
	<div class="page-header text-center">
	  <h1>Sticker Automated Deployment Tool</h1>
	</div>
	<div class="row main">
		<div class="col-md-5 col-lg-5 col-sm-5 col-xs-12" id="model" style="position:relative">
			<img src="./img/modelfe.png" id="model-image" class="img-rounded"/>
		</div>
		<div class="col-md-6 col-lg-6 col-sm-6 col-xs-12">
			<div class="row text-right">
				<button class="btn btn-success" style="font-size:10px;" id="finall">完成所有配置，生成配置文件</button>
			</div>
			<div class="row text-left" id="upload">
				<p class="bigfont left-2">上传贴纸</p>
				<div class="row top-2">
					<div class="col-md-2 col-lg-2 col-sm-2">
						<img src="./img/upload.png" class="img-thumbnail full" id="uploader"/>
						<input id="media" class="hidden" type="file" name="media"/>
					</div>
					<div class="col-md-10 col-lg-10 col-sm-10 text-right">

					</div>	
				</div>
				<div class="row top-2 uploaded">
					<!--<div class="col-md-3 col-lg-3 col-sm-3 sticker-div">-->
						<!--<img src="./img/ear.png" class="img-rounded full"/>-->
					<!--</div>	-->
					<!--<div class="col-md-3 col-lg-3 col-sm-3 sticker-div">-->
						<!--<img src="./img/nose.png" class="img-rounded full"/>-->
					<!--</div>-->
					<!--<div class="col-md-3 col-lg-3 col-sm-3 sticker-div">-->
						<!--<img src="./img/tooth.png" class="img-rounded full"/>-->
					<!--</div>-->
				</div>
			</div>
			<div class="row top-2" id="parameter" >
				<p class="bigfont">为每张贴纸配置参数</p>
				<p>1. 选择贴纸中心点位置</p>
				<div class="row text-left center-select">
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="eye"> 眼睛中心
					</label>
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="nose"> 鼻尖
					</label>
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="nostril"> 鼻翼中心
					</label>
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="upperlip_bottom"> 上唇下侧中心
					</label>
				</div>
				<div class="row text-left center-select">
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="underlip_top"> 下唇上侧中心
					</label>
					<label class="radio-inline">
					  <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="underlip_bottom"> 下唇下侧中心
					</label>
				</div>
				<p class="top-5">2. 调整贴纸的坐标偏移量</p>
				<div class="row">
					<div class="col-md-6 col-sm-6 col-lg-6 text-left sliders xslider-div">
						<b class="text-center">X偏移</b>
						<input type="text" value="" data-slider-min="-1" data-slider-max="1" data-slider-step="0.01" data-slider-value="0" data-slider-id="x" id="xslider" data-slider-tooltip="true" data-slider-handle="round" style="width:90%"/>
					</div>
					<div class="col-md-6 col-sm-6 col-lg-6 text-left sliders yslider-div">
						<b class="text-center">Y偏移</b>
						<input type="text" value="" data-slider-min="-2" data-slider-max="2" data-slider-step="0.01" data-slider-value="0" data-slider-id="y" id="yslider" data-slider-tooltip="true" data-slider-handle="round" style="width:90%"/>
					</div>
				</div>
				<p class="top-5">3. 调整贴纸的宽度</p>
				<div class="row text-left sliders widthslider-div">
					<input type="text" value="" data-slider-min="0" data-slider-max="1" data-slider-step="0.01" data-slider-value="0" data-slider-id="width" id="widthslider" data-slider-tooltip="true" data-slider-handle="round" style="width:90%"/>
				</div>
				<p class="top-5">4. 填入必要参数</p>
				<div class="row">
					<div class="col-md-7 col-lg-7 col-sm-7 col-xs-12">
						<input id="frame_folder" type="text" class="form-control left-2" placeholder="填入此贴纸所在文件夹名"/>
					</div>
					<div class="col-md-5 col-lg-5 col-sm-5 col-xs-12">
						<input id="frame_num" type="text" class="form-control left-2" placeholder="填入此贴纸序列图张数"/>
					</div>
				</div>

				<div class="row top-5 text-right bottom-5">
					<button id="fin" class="btn btn-success" style="width:40%;font-size:10px">完成对此张贴纸的配置</button>
				</div>
			</div>
		</div>
	</div>
		
	<img src="" style="display:none" id="tmp"/>

</body>

<script src="./js/jquery.latest.min.js"></script>
<script src="./js/bootstrap-slider.min.js"></script>
<script src="./js/ajaxfileupload.js"></script>

<script>

	var currentStickerIndex = 0;
	var stickersConfig = [];
	var selectedStickerObj = null;
	var currentStickerParam = null;
	var standardWidth = 480;
	var standardOffset = 15;
	var standardHeight = 720;
	var modelImageWidth = 0;
	var modelImageHeight = 0;
	var usedPoints = {
		p36 : {x: 145.090714, y: 388.185455},
		p28 : {x: 226.809326, y: 413.432007},
		p45 : {x: 316.302063, y: 386.818054},
		p31 : {x: 202.558029, y: 478.747101},
		p30 : {x: 224.125854, y: 464.141724},
		p35 : {x: 252.042282, y: 478.494385},
		p32 : {x: 213.580750, y: 482.631195},
		p33 : {x: 226.403198, y: 486.411560},
		p34 : {x: 239.940094, y: 482.355194},
		p61 : {x: 215.366150, y: 521.271179},
		p62 : {x: 228.104187, y: 521.828186},
		p63 : {x: 241.252060, y: 520.668823},
		p48 : {x: 183.998306, y: 525.298035},
		p66 : {x: 227.626801, y: 523.914185},
		p54 : {x: 278.198853, y: 522.706726},
		p48 : {x: 183.998306, y: 525.298035},
		p57 : {x: 228.023361, y: 547.001709}
  	};
  	var test = {x:226.809326, y:413.432007};
	var standardOffsetWidthScale = Math.sqrt(Math.pow((usedPoints.p36.x - usedPoints.p45.x), 2) + Math.pow((usedPoints.p36.y - usedPoints.p45.y), 2)) / standardWidth;

	var pointConfig = {
		"eye" : {
			widthBasePoints: [usedPoints.p36, usedPoints.p45],
			center: usedPoints.p28,
			pos: 2
		},
		"nose" : {
			widthBasePoints: [usedPoints.p31, usedPoints.p35],
			center: usedPoints.p30,
			pos: 4
		},
		"nostril" : {
			widthBasePoints: [usedPoints.p32, usedPoints.p34],
			center: usedPoints.p33,
			pos: 5
		},
		"upperlip_bottom" : {
			widthBasePoints: [usedPoints.p61, usedPoints.p63],
			center: usedPoints.p62,
			pos: 6
		},
		"underlip_bottom" : {
			widthBasePoints: [usedPoints.p48, usedPoints.p54],
			center: usedPoints.p66,
			pos: 7
		},
		"underlip_top" : {
			widthBasePoints: [usedPoints.p48, usedPoints.p54],
			center: usedPoints.p57,
			pos: 9
		}
	}

	$(document).ready(function(){
		setModelParam();
		initRangeSlider();
		$(".sticker-div").click(function(){
			stickerChosen($(this));
		});
		$("input[type='radio']").click(function(){
			if($(".uploaded>.active").size() == 0) {
				alert('请先选择一张贴纸!');
				$(this).prop('checked', false);
				return;
			}
			$("#widthslider").bootstrapSlider('setValue', 0);
			$("#xslider").bootstrapSlider('setValue', 0);
			$("#yslider").bootstrapSlider('setValue', 0);
			if($("#sticker_" + currentStickerIndex).size() != 0){
				$("#sticker_"+currentStickerIndex).remove();
			}
			var param = calculatePos($(this).val());
			addStickerToModel(param);
		});
		$("#next-step").click(function(){
			$(this).hide();
			$("#parameter").fadeIn(500);
		});
		$("#fin").click(function(){
			finishSticker();
		});
		$("#uploader").click(function(){
			$("#media").click();
		});
		$(document).on('change', 'input#media', function(){
			ajaxFileUpload();
		})
		$("#finall").click(function(){
			uploadConfig();
		})
	});

	function setModelParam(){
		document.getElementById("model-image").onload = function(){
			modelImageHeight = $(this).height();
			modelImageWidth = $(this).width();
		}
		modelImageHeight = modelImageHeight == 0 ? $("#model-image").height() : modelImageHeight;
		modelImageWidth = modelImageWidth == 0 ? $("#model-image").width() : modelImageWidth;
	}

	function uploadConfig(){
		var data = [];
		for(var i in stickersConfig){
			data[i] = stickersConfig[i].conf;
		}
		$.ajax({
			url: 'json.php',
			method: 'POST',
			dataType: 'json',
			data: JSON.stringify(data),
			success: function(data, textStatus, jqXHR){
				window.location.href = 'download.php';
			},
			error: function(){
				alert('error!');
			}

		})
	}

	
	function finishSticker(){
		var config = {};
		config.facePos = pointConfig[$("input[type='radio']:checked").val()].pos;
		config.scaleWidthOffset = $("#widthslider").bootstrapSlider('getValue');
		config.scaleXOffset = $("#xslider").bootstrapSlider('getValue');
		config.scaleYOffset = $("#yslider").bootstrapSlider('getValue');
		config.frameFolder = $("#frame_folder").val();
		config.frameNum = $("#frame_num").val();
		config.frameWidth = $("#tmp").width();
		config.frameHeight = $("#tmp").height();
		stickersConfig[currentStickerIndex]= {conf: config, pos: currentStickerParam};
	}
	

	function addStickerToModel(pos){
		var stickerTpl = '' +
			'<div id="sticker_' + currentStickerIndex + '" class="active" style="position:absolute;left:'+ (standardOffset + pos.x) +'px;top:' + pos.y + 'px;width:'+ pos.width +'px;">' +
				'<img class="full" src="'+ selectedStickerObj.attr("src") +'"/>' +
			'</div>';
		var addedSticker = $(stickerTpl);
		$("#model").append(addedSticker);
	}

	function calculatePos(value){
		var config = pointConfig[value];
		var param = {};
		var originLength = Math.sqrt(Math.pow((config.widthBasePoints[0].x - config.widthBasePoints[1].x), 2) + Math.pow((config.widthBasePoints[0].y - config.widthBasePoints[1].y), 2));
		param.width = originLength / standardWidth * modelImageWidth;
		param.x = (config.center.x / standardWidth) * modelImageWidth - (param.width / 2);
		param.y = (config.center.y / standardHeight) * modelImageHeight - ((param.width / selectedStickerObj.width() * selectedStickerObj.height()) / 2);
		currentStickerParam = {x: (config.center.x / standardWidth) * modelImageWidth , y: (config.center.y / standardHeight) * modelImageHeight, w: param.width};
		currentStickerParam.adjustedX = currentStickerParam.x;
		currentStickerParam.adjustedY = currentStickerParam.y;
		return param;
	}

	function stickerChosen(obj){
		obj.siblings().attr("style","").removeClass("active");
		obj.attr("style", "border-top:3px solid #62addf").addClass("active");
		currentStickerIndex = obj.index();
		$("#model").children().removeClass('active');
		selectedStickerObj = obj.children("img");
		$("#tmp").attr("src", selectedStickerObj.attr("src"));
	}

	function initRangeSlider(){
		$("#widthslider").bootstrapSlider();
		$("#xslider").bootstrapSlider();
		$("#yslider").bootstrapSlider();
		$("#widthslider").on("slide",function(){
			adjustStickerWidth($(this));
		});
		$("#xslider").on("slide", function(){
			adjustStickerX($(this));
		});
		$("#yslider").on("slide", function(){
			adjustStickerY($(this));
		});
		$(".xslider-div").mouseout(function(){
			setCurrentStickerX();
		})
		$(".yslider-div").mouseout(function(){
			setCurrentStickerY();
		})
	}

	function adjustStickerX(obj){
		if($("div#model>.active").size() == 0){return;}
		var adjustX = standardModelOffsetWidth() * obj.val();
		var left = parseFloat(currentStickerParam.x) + adjustX + standardOffset - $("div#model>.active>img").width() / 2;
		$("div#model>.active").css("left", (left + "px"));
	}

	function adjustStickerY(obj){
		if($("div#model>.active").size() == 0){return;}
		var adjustY = standardModelOffsetWidth() * obj.val();
		var top = parseFloat(currentStickerParam.y) + adjustY - $("div#model>.active>img").height() / 2;
		$("div#model>.active").css("top", (top + "px"));
	}

	function adjustStickerWidth(obj){
		if($("div#model>.active").size() == 0){return;}
		var modelStandardWidth = standardModelOffsetWidth();
		var adjustWidth = modelStandardWidth * obj.val();
		var width = currentStickerParam.w + adjustWidth;
		$("div#model>.active").css("width", (width+"px"));
		$("div#model>.active").css("left", ((parseFloat(currentStickerParam.adjustedX + standardOffset) - width / 2)+"px"));
		$("div#model>.active").css("top", ((parseFloat(currentStickerParam.adjustedY) - ((width / 2) / selectedStickerObj.width() * selectedStickerObj.height())) +"px"));

	}

	function setCurrentStickerX(){
		if($("div#model>.active").size() == 0){return;}
		var currentX = (parseFloat($("div#model>.active").css("left").substring(0, ($("div#model>.active").css("left")).length - 2)) - standardOffset) + $("div#model>.active>img").width() / 2;
		currentStickerParam.adjustedX = currentX;
	}

	function setCurrentStickerY(){
		if($("div#model>.active").size() == 0){return;}
		var currentY = parseFloat($("div#model>.active").css("top").substring(0, ($("div#model>.active").css("top")).length - 2)) + $("div#model>.active>img").height() / 2;
		currentStickerParam.adjustedY = currentY;
	}

	function setCurrentStickerW(){
		currentStickerParam.w = parseFloat($("div#model>.active").css("width").substring(0, ($("div#model>.active").css("width")).length - 2));
	}

	function standardModelOffsetWidth(){
		return standardOffsetWidthScale * modelImageWidth;
	}

	function addUploadedSticker(data){
		var tpl = '<div class="col-md-3 col-lg-3 col-sm-3 sticker-div">' +
					'<img src="' + data.file + '" class="img-rounded full"/>' +
				  '</div>';
		var dom = $(tpl);
		$(".uploaded").append(dom);
		$("img", dom).click(function(){
			stickerChosen($(this).parent());
		})
	}

	function ajaxFileUpload() {
		$.ajaxFileUpload
		(
				{
					url: 'file.php', //用于文件上传的服务器端请求地址
					secureuri: false, //是否需要安全协议，一般设置为false
					fileElementId: 'media', //文件上传域的ID
					dataType: 'json', //返回值类型 一般设置为json
					success: function (data, status)  //服务器成功响应处理函数
					{
						addUploadedSticker(data);
					},
					error: function (data, status, e)//服务器响应失败处理函数
					{
						alert("上传失败，请重试！");
					}
				}
		)
		return false;
	}

</script>

</html>